<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Searchbar Widget Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .left-panel {
            flex: 1;
            background: #f8f9fa;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .right-panel {
            flex: 1;
            background: #ffffff;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            overflow-y: auto;
        }

        .url-section {
            display: none;
        }

        .url-section.visible {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        textarea {
            resize: none;
            height: 120px;
        }

        button {
            padding: 14px 28px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        .customize-section {
            display: none;
            gap: 15px;
        }

        .customize-section.visible {
            display: flex;
            flex-direction: column;
        }

        .color-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-control label {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        input[type="color"] {
            width: 60px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .preview-container {
            width: 100%;
            max-width: 700px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .loading {
            font-size: 18px;
            color: #666;
        }

        .embed-code {
            display: none;
            width: 100%;
            max-width: 700px;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }

        .embed-code.visible {
            display: block;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            font-size: 12px;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="url-section" id="urlSection">
                <input type="text" id="urlInput" placeholder="Enter your website URL (e.g., https://example.com)">
                <button onclick="createEmbedCode()">Create Embed Code</button>
            </div>

            <textarea id="descriptionInput" placeholder="Describe your searchbar design (e.g., 'blue rounded searchbar with dark background')"></textarea>
            <button onclick="generateSearchbar()">Generate Searchbar</button>

            <div class="customize-section" id="customizeSection">
                <div class="color-control">
                    <label>Background Color</label>
                    <input type="color" id="bgColor" value="#ffffff" onchange="updateSearchbar()">
                </div>
                <div class="color-control">
                    <label>Text Color</label>
                    <input type="color" id="textColor" value="#333333" onchange="updateSearchbar()">
                </div>
                <div class="color-control">
                    <label>Border Color</label>
                    <input type="color" id="borderColor" value="#cccccc" onchange="updateSearchbar()">
                </div>
                <div class="color-control">
                    <label>Button Color</label>
                    <input type="color" id="buttonColor" value="#007bff" onchange="updateSearchbar()">
                </div>
                <div class="button-group">
                    <button onclick="updateSearchbar()">Update Colors</button>
                    <button class="secondary" onclick="generateSearchbar()">Regenerate</button>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="preview-container" id="previewContainer">
                <div class="loading">Preview will appear here</div>
            </div>
            <div class="embed-code" id="embedCode">
                <button class="copy-btn" onclick="copyEmbedCode()">Copy</button>
                <code id="embedCodeText"></code>
            </div>
        </div>
    </div>

    <script>
        let currentBorderRadius = '8px';
        let generatedHTML = '';

        async function generateSearchbar() {
            const description = document.getElementById('descriptionInput').value.trim();
            
            if (!description) {
                alert('Please enter a description');
                return;
            }

            // Show loader
            document.getElementById('previewContainer').innerHTML = '<div class="loader"></div>';
            
            try {
                const response = await fetch('http://localhost:3000/api/generate-searchbar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ description })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate searchbar');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                fullResponse += parsed.content;
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }

                // Extract HTML from markdown code blocks if present
                let htmlContent = fullResponse;
                const codeBlockMatch = fullResponse.match(/```html\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    htmlContent = codeBlockMatch[1];
                }

                generatedHTML = htmlContent.trim();

                // Display the generated searchbar
                document.getElementById('previewContainer').innerHTML = generatedHTML;

                // Try to extract colors for pickers (optional)
                extractColors(generatedHTML);

                // Show customize section and URL input
                document.getElementById('customizeSection').classList.add('visible');
                document.getElementById('urlSection').classList.add('visible');
                document.getElementById('embedCode').classList.remove('visible');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('previewContainer').innerHTML = '<div class="loading" style="color: red;">Failed to generate searchbar. Make sure the server is running.</div>';
            }
        }

        function extractColors(html) {
            // Try to extract colors from the generated HTML
            const bgMatch = html.match(/background:\s*([#\w]+)/);
            const colorMatch = html.match(/color:\s*([#\w]+)/);
            const borderMatch = html.match(/border.*?:\s*.*?([#\w]+)/);
            
            if (bgMatch) document.getElementById('bgColor').value = bgMatch[1];
            if (colorMatch) document.getElementById('textColor').value = colorMatch[1];
            if (borderMatch) document.getElementById('borderColor').value = borderMatch[1];
        }

        function createSearchbarHTML(bgColor, textColor, borderColor, buttonColor, borderRadius) {
            return `
                <div style="width: 100%; max-width: 600px;">
                    <div style="display: flex; gap: 8px; padding: 12px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: ${borderRadius}; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <input type="text" placeholder="Search..." style="flex: 1; padding: 12px 16px; border: none; background: transparent; color: ${textColor}; font-size: 16px; outline: none;" />
                        <button style="padding: 12px 24px; background: ${buttonColor}; color: white; border: none; border-radius: ${borderRadius}; cursor: pointer; font-size: 16px; font-weight: 600; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">Search</button>
                    </div>
                </div>
            `;
        }

        function updateSearchbar() {
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const borderColor = document.getElementById('borderColor').value;
            const buttonColor = document.getElementById('buttonColor').value;

            const html = createSearchbarHTML(bgColor, textColor, borderColor, buttonColor, currentBorderRadius);
            document.getElementById('previewContainer').innerHTML = html;
        }

        function createEmbedCode() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                alert('Please enter a URL first');
                return;
            }

            if (!generatedHTML) {
                alert('Please generate a searchbar first');
                return;
            }

            // Wrap the generated HTML with URL functionality
            const embedCode = `${generatedHTML}
<script>
(function() {
  const searchWidget = document.querySelector('[data-search-widget]') || document.currentScript.previousElementSibling;
  const input = searchWidget.querySelector('input[type="text"]');
  const button = searchWidget.querySelector('button');
  
  if (button && input) {
    button.addEventListener('click', function() {
      const query = input.value;
      if (query) window.open('${url}?q=' + encodeURIComponent(query), '_blank');
    });
    
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        button.click();
      }
    });
  }
})();
<\/script>`;

            document.getElementById('embedCodeText').textContent = embedCode;
            document.getElementById('embedCode').classList.add('visible');
        }

        function copyEmbedCode() {
            const embedCodeText = document.getElementById('embedCodeText').textContent;
            navigator.clipboard.writeText(embedCodeText).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
    </script>
</body>
</html>